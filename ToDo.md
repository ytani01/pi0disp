# `test.py` のリファクタリング計画

このドキュメントは、`src/pi0disp/commands/test.py` のアニメーションデモにおける描画アーティファクトの問題を修正し、コードの効率性と保守性を向上させるためのリファクタリング計画をまとめたものです。

## ステップ1: `Ball.draw` メソッドの簡略化と効率化

**問題点:**
現在の `Ball.draw` メソッドは、ボールを描画するたびに新しい `Image` オブジェクトとアルファマスクを生成しており、パフォーマンス上のボトルネックとなっています。

**修正内容:**
-   `Image.new` と `Image.paste` を使った複雑な描画処理を削除します。
-   代わりに `ImageDraw.Draw(image_buffer).ellipse()` を使用して、フレームバッファに直接ボールを描画するように変更します。
-   これにより、不要なオブジェクト生成がなくなり、描画処理が高速化されます。

## ステップ2: `FpsCounter` の描画処理を自己完結させる

**問題点:**
`FpsCounter` は、自身の表示領域をクリアする処理をメインループに依存しています。これはコンポーネントの独立性を損ない、将来的なバグの原因となり得ます。

**修正内容:**
-   `update_and_draw` メソッド内で、テキストを描画する前に、まず `initial_background_image` から自身の担当領域を切り出して貼り付け、背景を復元する処理を追加します。
-   これにより、`FpsCounter` は外部の状態に依存せず、自身の描画を完全に管理できるようになります。

## ステップ3: メインループのダーティ領域計算ロジックの修正

**問題点:**
`Ball.draw` の変更に伴い、メインループでのダーティ領域の計算方法が正しく機能しなくなります。以前は `draw` メソッドが更新領域を返していましたが、新しい実装では返さなくなります。

**修正内容:**
-   ボールの位置更新 (`update_position`) の後、描画 (`draw`) の前に、`prev_bbox` と `curr_bbox` を使ってダーティ領域を計算するようにロジックを再構築します。
-   `ball.draw(new_frame_image)` を呼び出す前に、`prev_bbox_before_update = ball.prev_bbox` のように前のバウンディングボックスを保存します。
-   `ball.update_position(...)` を呼び出します。
-   `curr_bbox_after_update = ball.get_bbox()` で新しいバウンディングボックスを取得します。
-   `dirty_region = merge_bboxes(prev_bbox_before_update, curr_bbox_after_update)` でダーティ領域を計算します。
-   その後、`ball.draw(new_frame_image)` を呼び出して描画します。

## ステップ4: 不要なコードの削除

**問題点:**
メインループの最後に、次フレームの比較用として `current_frame_image` を更新する `current_frame_image = new_frame_image.copy()` という処理がありますが、現在の差分描画ロジックではこのコピーは使用されていません。

**修正内容:**
-   この不要な行を削除し、メモリとCPUリソースの無駄遣いをなくします。

# 調査レポート：`ballanime` コマンドにおける `--mode` オプション削除の経緯

## 1. 調査概要
`uv run pi0disp ballanime` コマンドから削除された `--mode` オプションについて、Git履歴を遡り、その削除理由と当時の機能を調査した。

## 2. 調査結果

### 2.1 削除されたコミット
- **SHA**: `0bdd3d72672a6b92b43bd8c2f957d734dde9d346`
- **日時**: 2026年1月9日 13:00:32
- **コミットメッセージ**: `conductor(checkpoint): Checkpoint end of Phase 2 - performance_core_refactor_20260109`

### 2.2 削除理由
ドライバレベル（`ST7789V` クラス）で **Dirty Rectangle（差分更新）** 最適化が実装されたため。
従来、アプリケーション層（`ballanime.py`）で手動で行っていた描画領域の計算と部分更新（旧 `fast` モードの実装内容）が、ドライバ側で自動かつ透過的に行われるようになり、コードを簡素化できるようになった。

### 2.3 削除前の機能詳細
削除前、`--mode` オプションは以下の2つのモードを切り替えていた。

| モード | 説明 |
| :--- | :--- |
| `simple` (デフォルト) | 毎回背景をコピーし、全てのボールを描画してフレーム全体を `lcd.display()` で送信する。 |
| `fast` | `RegionOptimizer` を使用。ボールの現在位置と前回の位置から「汚れた領域（Dirty Region）」を算出し、`lcd.display_region()` を用いて変化のあった部分のみを更新する。 |

## 3. 技術的考察と復活の是非

### 3.1 現状の分析
現在の `pi0disp` アーキテクチャでは、`lcd.display(image)` を呼び出すと、ドライバ内部で前回のフレームとの差分が自動的に計算され、変化があった矩形領域のみが SPI で送信される。このため、アプリケーション側で `lcd.display_region()` を手動で制御するメリットが消失している。

### 3.2 復活の是非
**結論：現時点での復活は不要。**

- **理由**: 現在の「ドライバレベルでの自動最適化」は、アプリケーションコードをシンプルに保ちつつ、`fast` モードと同等以上のパフォーマンスを実現している。手動での領域計算（旧 `fast` モード）を復活させても、計算コストが増えるだけで SPI 送信データ量は変わらないため、実質的なメリットがない。
- **例外**: もし将来的に、ドライバレベルの差分検知では対応できない特殊な描画制御（例：レイヤー合成の最適化や、非常に複雑な動的エフェクトの部分更新）が必要になった場合には、再度検討の余地がある。

## 4. 次ステップの提案
本調査の結果に基づき、`--mode` オプションの復活は見送ることを推奨する。
代わりに、現在の自動最適化の効果をユーザーが確認できるよう、ベンチマーク出力（FPSやCPU負荷）のさらなる充実に注力することが望ましい。

# 調査レポート：src/pi0disp/utils/sprite.py の存在価値と活用について

## 1. 調査の目的
`src/pi0disp/utils/sprite.py` に定義されている `Sprite` クラスが、プロジェクト全体のコード品質やパフォーマンスにどのように寄与しているか（あるいは寄与し得るか）を検証し、今後の扱いについて結論を出す。

## 2. 実装内容の分析
### 提供機能
- `x`, `y`, `width`, `height` によるオブジェクトの状態管理。
- `merge_bboxes` を活用した `get_dirty_region()` による再描画領域の自動計算。
- 抽象メソッド `update()` および `draw()` による、アニメーションオブジェクトのIF定義。

### `ballanime.py` の `Ball` クラスとの比較
- **論理性**: Dirty Region の計算論理はほぼ同等であり、共通化が可能。
- **パフォーマンス**: `Ball` クラスは `__slots__` の使用や、座標が変化したときのみ更新するキャッシュ機構など、極限まで最適化されている。現状の `Sprite` はこれらに対応していない。
- **設計思想**: `Ball` は中心座標と半径ベース、`Sprite` は左上座標と矩形サイズベースという違いがある。

## 3. 評価
### メリット
- 差分更新（Dirty Rectangle）に必要な領域計算ロジックを各コマンドで再実装する必要がなくなる。
- 複数の動的要素（アイコン、テキスト、キャラ等）を統一的に扱える。

### デメリット・課題
- 汎用性を重視しているため、`ballanime` のような超高速描画が求められるケースでは、特化実装に比べてわずかなオーバーヘッドが発生する。
- 現在の実装には `__slots__` がなく、大量のオブジェクト（数百個〜）を扱う際にはメモリ・速度面で不利。

## 4. 結論と推奨アクション
**結論：`sprite.py` は有用な共通基盤であり、維持すべきである。**

### 推奨アクション
1.  **既存コードへの適用**: パフォーマンスがクリティカルな `ballanime` への即時適用は見送る。一方で、今後作成される新しいデモや、UI要素の描画には `Sprite` クラスを積極的に利用する。
2.  **基盤の強化**:
    - `__slots__` を導入し、属性アクセスの高速化を図る。
    - オプションとして「座標変化なし時のDirty Region計算スキップ」などの最適化フラグを追加する。
    - 円形オブジェクトに対応しやすいよう、中心座標ベースのサブクラス（例: `CircleSprite`）を追加検討する。

---
作成日: 2026-01-09
調査担当: Serena (AI Agent)

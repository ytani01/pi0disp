---
track_id: st7789v_driver_check_20251230
---

# Track: ST7789V ドライバ実装の妥当性確認と修正

## 1. フェーズ: 初期調査とテストの準備 [checkpoint: deb3e4c]

### 目標
既存ドライバの実装をデータシートと照らし合わせて初期調査を行い、修正が必要な領域を特定する。
また、問題再現のためのテスト環境を準備し、現在の問題（kill後のディスプレイ再表示不可）を再現するテストケースを作成する。

### タスク
- [x] タスク: `ST7789V` クラスの初期実装を詳細にレビューする。
  - [x] サブタスク: `init_display()` メソッド内の初期化シーケンス（コマンドと遅延）を特に注意して確認する。
  - [x] サブタスク: `set_rotation()` メソッド内の `MADCTL` コマンドとその設定値をデータシートと照合する。
  - [x] サブタスク: その他のコマンド (`CMD`辞書の内容) およびそれらの使用方法を確認する。
- [x] タスク: 問題再現のためのテスト環境を構築する。
  - [x] サブタスク: `kill` コマンド後のディスプレイ再表示不可問題を再現するための手動テスト手順を策定する。
  - [x] サブタスク: 必要であれば、自動テストで問題を再現するための基盤を検討する（現状では困難な可能性あり）。
- [x] タスク: フェーズ完了: Conductor - ユーザー手動検証 '初期調査とテストの準備' (workflow.mdのプロトコル)

## 2. フェーズ: 問題特定とテスト駆動開発 (TDD) [checkpoint: 2185271]

### 目標
「プログラムをkillした後にディスプレイが映らなくなることがある」問題の根本原因を特定し、データシートの仕様に準拠した修正をTDDプロセスに従って実装する。

### タスク
- [x] タスク: 問題の根本原因を特定する。
  - [x] サブタスク: ディスプレイが再表示されない問題について、`DispSpi`基底クラスや`ST7789V`クラスの`close()`メソッド、またはSPI通信周りのリソース解放・初期化不足の可能性を調査する。
  - [x] サブタスク: `dmesg`やシステムログなどで、関連するエラーや警告が出ていないか確認する。
- [x] タスク: 問題を再現するテストケースを記述する (Red Phase)。
  - [x] サブタスク: 異常終了後の再初期化に失敗するケースを想定したテストを作成する。
- [x] タスク: 修正を実装する (Green Phase)。
  - [x] サブタスク: `init_display()`シーケンスに、より堅牢なリセット処理（例: さらなる遅延、追加のリセット関連コマンド）を追加する。
  - [x] サブタスク: `close()`メソッドに、ディスプレイを完全に停止させるためのコマンド（例: `DISPOFF`, `SLPIN`）を追加することを検討する。
- [ ] タスク: 実装をリファクタリングする (Optional)。
- [ ] タスク: テストカバレッジを確認する。
- [ ] タスク: フェーズ完了: Conductor - ユーザー手動検証 '問題特定とテスト駆動開発 (TDD)' (workflow.mdのプロトコル)

## 3. フェーズ: 汎用性と堅牢性の向上

### 目標
データシートとの詳細な比較に基づき、ドライバの汎用性と堅牢性をさらに向上させる。

### タスク
- [ ] タスク: データシートに記載されているが、現在の実装で不足している、または不適切に使用されているコマンドや設定を確認する。
  - [ ] サブタスク: 特に、色の順序 (`BGR`)、色反転 (`INVON`/`INVOFF`)、ガンマ補正などのオプション設定を見直す。
- [ ] タスク: 不足しているテストケースを追加する。
  - [ ] サブタスク: `BGR`、`INVON`/`INVOFF`の切り替え機能に関するテストを作成する。
- [ ] タスク: 汎用性向上のためのオプションを追加する (Green Phase)。
  - [ ] サブタスク: `__init__`に`invert: bool = True`と`bgr: bool = True`パラメータを追加する。
  - [ ] サブタスク: `CMD`辞書に`INVOFF`を追加する。
  - [ ] サブタスク: `init_display()`で`invert`フラグに応じて`INVON`/`INVOFF`を切り替えるようにする。`SLPOUT`後の遅延を120msに短縮する。
  - [ ] サブタスク: `set_rotation()`で`bgr`フラグに応じて`MADCTL`の値を調整するようにする。
- [ ] タスク: 実装をリファクタリングする (Optional)。
- [ ] タスク: テストカバレッジを確認する。
- [ ] タスク: フェーズ完了: Conductor - ユーザー手動検証 '汎用性と堅牢性の向上' (workflow.mdのプロトコル)

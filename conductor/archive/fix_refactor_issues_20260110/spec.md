# Specification: `spec.md`

## Overview
`review_result.md` の指摘事項に基づき、アニメーションシステムのバグ修正（座標形式の不一致）および画像処理・描画ロジックの最適化を行い、それらに合わせて関連マニュアルを更新します。

## Functional Requirements
- **[重要度: 高] 座標形式の統一**: `Sprite.get_dirty_region()` を `(x0, y0, x1, y1)` 形式から、オプティマイザが期待する `(x, y, w, h)` 形式に変更します。
- **[重要度: 中] 変換処理の高速化**: `ballanime.py` 内の Cairo と PIL の相互変換において、低速な `split()`/`merge()` を廃止し、NumPy のスライス操作によるチャンネル並べ替えを導入します。
- **[重要度: 中] 描画オーバーヘッドの削減**: 最適化モードにおいて、領域ごとに `ImageDraw` を作成するのをやめ、描画順序を整理することで処理効率を向上させます。
- **[重要度: 中] メモリコピーの最適化**: ドライバ（`ST7789V`）の `display` メソッドにおいて、全画面の `copy()` を避け、差分領域のみをキャッシュにパッチ適用する方式に変更します。
- **[重要度: 低] レポート出力の改善**: ベンチマークレポートに `Mem (pig)` (pigpiodのメモリ使用量) を追加し、ヘッダーとデータの一貫性を保ちます。
- **ドキュメントの同期**: 修正したインターフェース（`Sprite` 等）や最適化ロジックの変更に合わせて、`docs/` 配下の関連マニュアル（`sprite-manual.md`, `performance_core_manual.md` 等）を更新します。

## Non-Functional Requirements
- **実装原則（憶測厳禁）**: 修正過程において推測に頼らず、ログや実際の動作、スタックトレースに基づいて原因を確認し、対処します。
- **パフォーマンス**: 最適化により、特に `cairo-optimized` モードでの FPS 低下を抑制します。
- **視覚的検証**: 描画の正常性を確認する際、可能な限り実画面のキャプチャ画像を出力し、事実に基づいて表示状態を確認します。

## Acceptance Criteria
- [ ] すべての自動テスト（既存テストおよび座標変換の新規検証テスト）がパスすること。
- [ ] `ballanime` の `optimized` および `cairo-optimized` モードを実行した際、描画崩れがなく正しく表示されること。検証時にはキャプチャ画像を確認すること。
- [ ] `ballanime-report.md` に `Mem (pig)` 列が追加され、正しく計測値が記録されること。
- [ ] `docs/` 内の関連マニュアルが、修正後のコードと整合していること。
- [ ] `mise run lint` による静的解析でエラーが出ないこと。

## Out of Scope
- 指摘事項以外の新規機能追加。
- `performance_core.py` の `RegionOptimizer` アルゴリズム自体の根本的な変更。

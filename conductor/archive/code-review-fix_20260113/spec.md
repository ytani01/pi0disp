# Spec: コードレビュー指摘事項に基づくリファクタリングと最適化

## 1. Overview
`samples/roboface.py` のコードレビューで指摘された問題点（潜在的なバグ、精度不足、環境依存のテスト）を修正し、コードの堅牢性と保守性を向上させる。

## 2. Functional Requirements
- **RfAnimationEngine の堅牢性向上**
    - `run` メソッド内での表情適用時に、`updater` が `None` である可能性を考慮したガード条件を追加する。
- **視線移動計算の安定化**
    - `adjusted_lerp_factor` の計算において、`interval` が 0 または極めて小さい値の場合に、ゼロ除算や不安定な挙動（大きな指数計算など）を防ぐガード処理を実装する。
- **レンダリング設定の柔軟性向上**
    - `RfRenderer.render_parts` 内でハードコードされているパディングのセンタリング設定（`0.1, 0.5`）を、定数または設定値（`RfConfig` 等）から取得するように変更する。
- **アニメーション精度の向上**
    - `RandomMode` および `InteractiveMode` のメインループにおいて、NTP同期等の影響を受けにくい `time.perf_counter()` を使用するように変更し、タイミングドリフトの抑制を強化する。

## 3. Non-Functional Requirements
- **テストの信頼性向上**
    - パフォーマンス計測テスト (`tests/test_review_performance.py`) において、絶対的な時間（ms）による判定を廃止する。
    - 代わりに、キャッシュ「なし」と「あり」の状態を比較し、有意な改善（例: 50%以上の高速化）が見られることを検証する相対評価ロジックを導入する。

## 4. Acceptance Criteria
- [ ] すべての修正箇所において、既存の機能が損なわれていないこと。
- [ ] `adjusted_lerp_factor` 計算時に異常な値が入力されてもプログラムがクラッシュしないこと。
- [ ] `time.perf_counter()` への移行後、アニメーションの間隔が正しく維持されていること。
- [ ] パフォーマンス向上テストが、異なるスペックの環境でも安定してパスすること。
- [ ] `mise run lint` および `mise run test` がすべてパスすること。

## 5. Out of Scope
- 表情データの追加や変更。
- ディスプレイドライバ（`ST7789V` クラス）自体の修正。

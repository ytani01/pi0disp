---
track_id: st7789v_driver_check_20251230
version: 1
---

# Track: ST7789V ドライバ実装の妥当性確認と修正

## 1. 概要 (Overview)

ST7789V LCDドライバ (`src/pi0disp/disp/st7789v.py`) の実装をデータシート (`docs/ST7789V.pdf`) と照らし合わせて検証し、信頼性を向上させる。
また、現在発生している「プログラムを強制終了 (kill) した後に、ディスプレイが再表示されなくなる」問題を解決する。

## 2. 機能要求 (Functional Requirements)

- **FR1: 安定した初期化とリセット**
  - アプリケーション起動時に、ディスプレイが常に確実に初期化されること。
  - `SWRESET`コマンドの適切な使用法や、データシートで推奨される待機時間を見直し、`init_display()`シーケンスを修正する。

- **FR2: 正常な終了処理**
  - `close()`メソッドが呼ばれた際、あるいはプログラムが終了する際に、ディスプレイが不定な状態に陥らないようにする。
  - バックライトをオフにするだけでなく、必要であれば`DISPOFF`や`SLPIN`などのコマンドを発行し、ディスプレイを安全な状態に遷移させる。

- **FR3: プログラム強制終了後の復帰**
  - `kill`コマンドなどでプログラムが異常終了した後でも、次にプログラムを起動した際にディスプレイが正常に再初期化され、表示が復帰すること。

## 3. 非機能要求 (Non-Functional Requirements)

- **NFR1: 信頼性**
  - データシートの仕様に基づいた、より堅牢で信頼性の高いドライバ実装であること。
- **NFR2: 既存機能の維持**
  - この修正によって、既存の表示機能（画像表示、回転など）が損なわれないこと。

## 4. 受け入れ基準 (Acceptance Criteria)

- `init_display()`メソッドがデータシートの推奨シーケンスに沿って修正されている。
- プログラムを複数回`kill`で停止させた後でも、再起動時にディスプレイが問題なく表示される。
- `close()`メソッドを呼び出すと、ディスプレイが適切にオフ状態になる。
- 既存のテストケースがすべてパスする。

## 5. 範囲外 (Out of Scope)

- 新機能の追加（例: 部分描画、スクロール機能など）。
- `invert`や`bgr`などの、直接問題解決に関係しないオプションの追加。
- パフォーマンスの劇的な改善。

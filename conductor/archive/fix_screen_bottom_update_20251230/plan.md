# Track: 画面下部更新不具合修正

## 1. 概要
- [x] `uv run samples/color_test_fix.py` の実行において、ST7789Vディスプレイの画面下部が正しく更新されない問題を修正する。この問題は、色の修正後に発覚したもので、ディスプレイの描画範囲や更新メカニズムに関連している可能性が高い。

## 2. 調査計画
### 2.1. ST7789Vデータシートの再確認
- [x] ディスプレイの描画コマンド（特に `set_column_address`, `set_page_address`, `write_memory_start`）とそのパラメータ、およびこれらのコマンドが画面の更新領域にどのように影響するかを再確認する。
- [x] `ST7789V.pdf` (docs/ST7789V.pdf) を精査し、特に `MADCTL`, `COLMOD`, `CASET`, `RASET` レジスタの設定を確認する。
- [x] `read_file` ツールで `docs/ST7789V.pdf` を読み、関連するレジスタの説明を抽出する。

### 2.2. 既存コードの分析
- [x] `src/pi0disp/disp/st7789v.py` 内の `display` および `display_region` メソッドを分析し、画面の初期化、描画領域の設定、画像データの送信ロジックを確認する。
- [x] 特に、`_set_window` メソッドが正しく描画領域を設定しているか、また、`_write_pixels` メソッドが期待通りにデータを送信しているかを重点的に調査する。
- [x] `st7789v.py` の関連するコードブロックを `read_file` ツールで読み込む。

### 2.3. テスト用のコードパスの特定
- [x] `samples/color_test_fix.py` や `samples/lcd_check.py` をもとに、問題の再現を容易にするための最小限のコードパスを特定する。
- [x] 画面下部のみを更新する、または特定の領域のみを更新するテストケースを作成する可能性を検討する。

## 3. 修正計画
### 3.1. 描画領域設定の調整
- [x] 調査計画の結果に基づき、`_set_window` メソッドのパラメータや、`CASET`, `RASET` レジスタの設定を調整する。
- [x] ディスプレイのオフセットや有効表示領域が正しく考慮されているか確認する。

### 3.2. データ送信メカニズムの確認
- [x] `_write_pixels` メソッドにおけるデータ送信が、設定された描画領域と一致しているか確認する。
- [x] バッファのオフセットや長さが正しく計算されているかを確認する。

## 4. 検証計画
### 4.1. ターゲットテストの作成
- [x] 画面下部の更新が正しく行われることを検証するための新しいテストスクリプトを作成する（例: `samples/test_bottom_update.py`）。
- [x] テスト内容は、画面下部に特定のパターンや色を描画し、その結果を視覚的に確認できるようにする。

### 4.2. 視覚的検証
- [x] `uv run samples/test_bottom_update.py` を実行し、ディスプレイの画面下部が正しく更新されていることをユーザーが視覚的に確認する。
- [x] 可能であれば、問題が解消されたことを示す画像を `docs/` ディレクトリに保存する。

### 4.3. 既存テストの実行
- [x] 既存のすべてのテスト (`mise run test`) が引き続きパスすることを確認する。

## 5. リンティングとテスト
- [x] 修正後、`mise run lint` を実行し、リンティングエラーがないことを確認する。
- [x] `mise run test` を実行し、すべての自動テストがパスすることを確認する。

## 6. コミット
- [x] 修正内容と新しいテストをコミットする。

## 7. プロジェクトドキュメントの同期
- [x] `product.md`, `tech-stack.md`, `product-guidelines.md` など、関連するプロジェクトドキュメントが必要に応じて更新されていることを確認する。

- [x] Task: Conductor - User Manual Verification '画面下部更新不具合修正' (Protocol in workflow.md)
# spec.md

## Overview
`samples/roboface.py` に対するコードレビューで指摘された機能的な不具合（L552, L740, L924）を修正する。本トラックでは、「推測を排した事実ベースのデバッグ」と「自動テストによる検証の徹底」を最優先事項とする。

## Functional Requirements
1.  **即時表情変化の有効化 (L552):**
    *   `duration=0.0` 指定時にデフォルト値で上書きされるバグを修正し、即時の表情切り替えを可能にする。
2.  **文字列による背景色指定の修正 (L740, L938):**
    *   `bg_color` に文字列が指定された際、パディング色が黒に固定される問題を修正し、指定色が正しく反映されるようにする。
3.  **背景キャッシュの無効化ロジックの実装 (L924):**
    *   `bg_color` 変更時にキャッシュ画像が更新されない問題を修正し、動的な背景色変更を可能にする。

## Non-Functional Requirements
*   **事実に基づく検証:** 修正前にデバッグログやイメージキャプチャ（Pillowでの画像保存等）を用いて、不具合の挙動を「事実」として確認する。
*   **自動テストの最大化:** ユーザーの手動確認を最小限にするため、以下の検証を自動化する。
    *   経過時間と表情変化率のロジック検証。
    *   生成された画像のパディング部分のピクセル色検証。
    *   キャッシュ更新後の画像内容の検証。
*   **TDDの遵守:** 修正前に失敗するテストを書き、修正後にパスすることを確認する。

## Acceptance Criteria
*   `duration=0.0` の場合、1フレーム目からターゲットの表情になっていることが自動テストで証明されていること。
*   文字列指定の背景色（例: `"white"`）が、生成された画像のパディング領域（隅のピクセル等）に正しく反映されていることが自動テストで検証されていること。
*   背景色変更直後の `render_parts` が、新しい色で描画されていることが自動テストで検証されていること。
*   全テストがパスし、追加の手動操作なしで品質が保証されていること。

## Out of Scope
*   その他の指摘事項（L107, L314, L349）は本トラックの対象外。

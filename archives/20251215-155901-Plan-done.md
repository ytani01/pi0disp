# `tests/test_01_disp_base.py` 改善プラン

現在のユニットテストは機能的に正しいが、コードの可読性、保守性、一貫性をさらに向上させるためのリファクタリング案を以下にまとめる。

## 1. 現状の評価

- **良い点**:
    - `DispBase` の主要な機能は網羅的にテストされている。
    - `mock` を使用してハードウェア依存性が排除されており、適切なユニットテストとなっている。
    - `__init__` における辞書のミュータブルな性質に起因するバグを発見・修正できた。

- **改善可能な点**:
    - **モックの冗長性**: すべてのテストメソッドに同じ `@mock.patch` デコレータが重複して記述されている。
    - **テストの粒度**: 一部のテストメソッド（例: `test_set_rotation`）が複数の関心事を含んでいる。
    - **インスタンス生成の重複**: `__init__` のテスト以外でも、各テストメソッド内で `DispBase` のインスタンスが都度生成されており、冗長な部分がある。

## 2. 改善方針

### 方針A: モック管理の一元化とDRY原則の適用

テストクラス全体で共通して使用する `pigpio` と `get_logger` のモックを、`setUp` メソッドで一元的に管理する。

- **具体策**:
    1. 各テストメソッドから `@mock.patch` デコレータをすべて削除する。
    2. `setUp` メソッド内で `mock.patch()` を使用してパッチを開始し、返された `patcher` オブジェクトをインスタンス変数（例: `self.patcher_pi`）に保持する。
    3. `addCleanup(self.patcher_xx.stop)` を呼び出し、テスト終了後に自動的にパッチが停止されるように登録する。
    4. 開始したモックオブジェクト (`mock_pigpio` など) もインスタンス変数 (`self.mock_pigpio`) として保持し、各テストメソッドから `self` 経由でアクセスできるようにする。

- **期待される効果**:
    - テストコードの重複が減り、DRYになる。
    - 各テストメソッドのシグネチャからモックの引数がなくなり、コードがシンプルになる。
    - モックのセットアップロジックが `setUp` に集約され、管理しやすくなる。

### 方針B: テストの責務分割とセットアップの共通化

各テストメソッドが単一の責任を持つようにし、共通のセットアップを `setUp` にまとめる。

- **具体策**:
    1. **テストの分割**: `test_set_rotation` を、90度への回転をテストする `test_set_rotation_to_90` と、0度への回転をテストする `test_set_rotation_to_0` の2つの独立したメソッドに分割する。
    2. **インスタンスの共通化**:
        - `setUp` 内で、標準的なテストで使用する `DispBase` インスタンス (`self.disp_base`) を `rotation=0` で一度だけ生成する。
        - `__init__` 自体をテストする `test_init_success` と `test_init_pigpio_connection_error` を除く、すべてのテストメソッド（`test_init_display`, `test_set_rotation_*`, `test_display`, `test_close`）では、この `self.disp_base` を使用する。これにより、各メソッド内でのインスタンス生成コードが不要になる。

- **期待される効果**:
    - テストの意図がより明確になる。
    - テストが失敗した際に、問題のある箇所を特定しやすくなる。
    - コードの重複が減り、一貫性が向上する。

## 3. 実装計画

上記の方針に基づき、以下の手順で `tests/test_01_disp_base.py` をリファクタリングする。

1. `setUp` メソッドを修正し、方針A（モック管理の一元化）と方針B（インスタンスの共通化）を適用する。
2. 各テストメソッドからデコレータとモック引数を削除し、`self` 経由でモックと共通インスタンスにアクセスするように修正する。
3. `test_set_rotation` を2つのメソッドに分割する。
4. `test_init_success` と `test_init_pigpio_connection_error` は、`setUp` の設定とは独立してインスタンスを生成する必要があるため、現状のロジックを維持しつつ、モックへのアクセス方法のみ `self` 経由に変更する。
5. 全ての変更が完了した後、再度 `uv run pytest` を実行し、すべてのテストがパスすることを確認する。

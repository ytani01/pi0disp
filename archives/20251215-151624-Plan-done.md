# `tests/test_01_disp_base.py` 作成プラン

`src/pi0disp/disp/disp_base.py` のユニットテスト `tests/test_01_disp_base.py` を作成するための計画。

## 1. テスト対象の分析

`DispBase`クラスの主要な機能は以下の通り。

- **初期化 (`__init__`)**: `pigpio`への接続、ロガーのセットアップ、各種プロパティ（`size`, `rotation`など）の初期化。
- **`init_display`メソッド**: サブクラスでのオーバーライドを促す警告ログの出力。
- **`set_rotation`メソッド**: `rotation`の値に応じて、ディスプレイの幅と高さを更新。
- **`display`メソッド**: 入力画像をディスプレイサイズに合わせてリサイズ。
- **`close`メソッド**: `pigpio`の接続を停止。

## 2. モック化する対象

- **`pigpio`**: 実際のハードウェア操作を避けるため、`unittest.mock`を使用して完全にモック化する。`pi`インスタンスの`connected`属性や`stop`メソッドの呼び出しをシミュレートする。
- **`pi0disp.utils.mylogger.get_logger`**: ログ出力をキャプチャし、期待されるメッセージが記録されるか検証するためにモック化する。
- **`PIL.Image.Image`**: `resize`メソッドが期待通りに呼び出されるか検証するために、`Image`オブジェクトとそのメソッドをモック化する。

## 3. テストケースの設計

### `TestDispBase` クラス

#### `setUp` メソッド

- `unittest.mock.patch`を使い、`pigpio`と`mylogger`をモック化する。
- テストで使用するデフォルトの`size`と`rotation`を定義する。
- `DispBase`のインスタンスを生成する。

#### `test_init_success`

- `DispBase`が正常にインスタンス化されることを確認する。
- `self.pi.connected`が`True`の状態で、`__init__`がエラーなく完了することを確認する。
- `size`, `_native_size`, `_rotation`などのプロパティが期待通りに設定されていることをアサートする。
- `pigpio.pi()`が1回呼び出されたことを確認する。

#### `test_init_pigpio_connection_error`

- `self.pi.connected`が`False`を返すようにモックを設定する。
- `DispBase`のインスタンス化時に`RuntimeError`が発生することを `with self.assertRaises(RuntimeError):` を使って確認する。

#### `test_init_display`

- `disp_base.init_display()`を呼び出す。
- モック化したロガーの`warning`メソッドが「Please override this method.」というメッセージで呼び出されたことを確認する。

#### `test_set_rotation`

- **90度と270度回転**:
    - `disp_base.set_rotation(90)` と `disp_base.set_rotation(270)` をそれぞれ呼び出す。
    - `disp_base.size["width"]`と`disp_base.size["height"]`が、`_native_size`の高さと幅にそれぞれ入れ替わっていることを確認する。
- **0度と180度回転**:
    - `disp_base.set_rotation(0)` と `disp_base.set_rotation(180)` をそれぞれ呼び出す。
    - `disp_base.size`が`_native_size`と同じ値であることを確認する。

#### `test_display`

- `DispBase`の`size`とは異なるサイズのモック`Image`オブジェクトを作成する。
- `disp_base.display(mock_image)`を呼び出す。
- モック`Image`の`resize`メソッドが、`disp_base.size`と同じタプルを引数として1回呼び出されたことを確認する。

#### `test_close`

- `disp_base.close()`を呼び出す。
- モック化した`pi.stop()`メソッドが1回呼び出されたことを確認する。

## 4. ファイル構成

- テストファイル: `tests/test_01_disp_base.py`
- テストフレームワーク: `unittest`
- モックライブラリ: `unittest.mock`

上記計画に沿って、`tests/test_01_disp_base.py`の実装を進める。

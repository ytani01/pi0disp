# Tasks01.md - `tests/test_13_cmd_bl.py` リファクタリングタスクリスト

## 1. 事前準備

- [x] 現在の作業ディレクトリが `pi0disp` のルートであることを確認する。
- [ ] 変更対象ファイル (`tests/test_13_cmd_bl.py`) のバックアップ（必要であれば）。

## 2. 共通モック環境設定用フィクスチャの作成

- [x] `tests/test_13_cmd_bl.py` 内に `bl_mock_env` という名前の `pytest` フィクスチャを作成する。
    - [x] フィクスチャ内で `patch("pi0disp.commands.bl.pigpio.pi")` を使用し、`mock_pi_constructor` を取得する。
    - [x] `mock_pi_constructor.return_value` として `mock_pi_instance = MagicMock()` を作成する。
    - [x] `mock_pi_instance.connected = True` を設定する。
    - [x] `mock_pi_instance.get_PWM_dutycycle.return_value = 0` を設定する。
    - [x] `patch("pi0disp.disp.disp_conf.Dynaconf")` を使用し、`mock_dynaconf_class` を取得する。
    - [x] `mock_dynaconf_instance = MagicMock()` を作成する。
    - [x] `mock_dynaconf_instance.get.return_value = MagicMock()` を設定する（`get().spi.bl` の呼び出しに対応するため）。
    - [x] `mock_dynaconf_class.return_value = mock_dynaconf_instance` を設定する。
    - [x] フィクスチャが `(mock_pi_instance, mock_dynaconf_instance)` のタプルを `yield` するようにする。
- [x] ヘルパー関数 `run_with_mocks` を削除する。

## 3. 各テスト関数の書き換え

### 3.1. `test_config_nonzero` の書き換え

- [x] テスト関数の引数に `bl_mock_env` を追加する。
- [x] `mock_pi_instance, mock_dynaconf = bl_mock_env` のようにアンパックする。
- [x] `bl_pin = 23` を定義する。
- [x] `mock_dynaconf.get.return_value.spi.bl = bl_pin` を設定する。
- [x] `CliRunner().invoke(bl_cmd, [str(brightness)])` でコマンドを実行し、`result` を取得する。
- [x] `assert result.exit_code == 0` を確認する。
- [x] `mock_pi_instance.set_PWM_dutycycle.assert_called_once_with(bl_pin, brightness)` を確認する。

### 3.2. `test_config_zero` の書き換え

- [x] テスト関数の引数に `bl_mock_env` を追加する。
- [x] `mock_pi_instance, mock_dynaconf = bl_mock_env` のようにアンパックする。
- [x] `mock_dynaconf.get.return_value.spi.bl = 0` を設定する。
- [x] `CliRunner().invoke(bl_cmd, [str(brightness)])` でコマンドを実行し、`result` を取得する。
- [x] `assert result.exit_code == 0` を確認する。
- [x] `mock_pi_instance.set_PWM_dutycycle.assert_not_called()` を確認する。

### 3.3. `test_option_nonzero` の書き換え

- [x] テスト関数の引数に `bl_mock_env` を追加する。
- [x] `mock_pi_instance, mock_dynaconf = bl_mock_env` のようにアンパックする。
- [x] `bl_pin = 15` を定義する。
- [x] `brightness = 128` を定義する。
- [x] `mock_dynaconf.get.return_value.spi.bl = 23` (オプションが優先されることを確認するために、設定ファイルに別の値を設定)
- [x] `CliRunner().invoke(bl_cmd, ["--bl", str(bl_pin), str(brightness)])` でコマンドを実行し、`result` を取得する。
- [x] `assert result.exit_code == 0` を確認する。
- [x] `mock_pi_instance.set_PWM_dutycycle.assert_called_once_with(bl_pin, brightness)` を確認する。

### 3.4. `test_option_zero` の書き換え

- [x] テスト関数の引数に `bl_mock_env` を追加する。
- [x] `mock_pi_instance, mock_dynaconf = bl_mock_env` のようにアンパックする。
- [x] `brightness = 100` を定義する。
- [x] `mock_dynaconf.get.return_value.spi.bl = 23` (オプションが優先されることを確認するために、設定ファイルに別の値を設定)
- [x] `CliRunner().invoke(bl_cmd, ["--bl", "0", str(brightness)])` でコマンドを実行し、`result` を取得する。
- [x] `assert result.exit_code == 0` を確認する。
- [x] `mock_pi_instance.set_PWM_dutycycle.assert_not_called()` を確認する。
- [x] `result.output` に `"no backlight: do nothing"` が含まれることを確認する（任意だが推奨）。

### 3.5. `test_clamp_with_config` の書き換え

- [x] テスト関数の引数に `bl_mock_env` を追加する。
- [x] `mock_pi_instance, mock_dynaconf = bl_mock_env` のようにアンパックする。
- [x] `bl_pin = 23` を定義する。
- [x] `mock_dynaconf.get.return_value.spi.bl = bl_pin` を設定する。
- [x] `pytest.mark.parametrize` を使用して、以下のシナリオをテストする。
    - [x] `(["300"], 255)`: 255を超える値を指定した場合
    - [x] `(["--", "-10"], 0)`: 0未満の値を指定した場合
- [x] 各シナリオで `CliRunner().invoke(bl_cmd, input_args)` を実行し、`result` と `mock_pi_instance.set_PWM_dutycycle` の呼び出しを確認する。
- [x] `mock_pi_instance.set_PWM_dutycycle.call_count` の確認を、`set_PWM_dutycycle` がシナリオごとに1回ずつ呼び出されたことを確認するように調整する。

### 3.6. `test_help_message` の調整

- [x] このテストは `bl_mock_env` を必要としないため、そのまま維持する。

## 4. 実施後の確認

- [ ] `mise run lint` を実行し、コードスタイルが維持されていることを確認する。
- [ ] `mise run test` を実行し、すべてのテストがエラーなくパスすることを確認する。
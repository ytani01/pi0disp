## Plan01.md: `src/pi0disp/disp/disp_base.py` テストカバレッジ100%達成計画書

### 1. 目的
`src/pi0disp/disp/disp_base.py` のテストカバレッジを100%に向上させることを目的とします。これにより、コードの品質と堅牢性を高め、将来の変更に対する安全性を確保します。

### 2. 現在の状況分析
`disp_base.py` には、ディスプレイの基本的な設定（サイズ、回転）、pigpioとの連携、コンテキストマネージャ、および設定ファイルからの情報読み込み機能が含まれています。
既存の `tests/test_01_disp_base.py` は、コンストラクタの成功/失敗、回転設定、画像表示時のリサイズ、`close` メソッド、コンテキストマネージャ、設定ファイルからの読み込みなど、主要な機能の一部をカバーしています。

しかし、以下の点においてテストカバレッジが不足している可能性があります。

*   `__init__` メソッドにおける `debug=True` 時のロギング挙動の検証。
*   `rotation` プロパティのsetterにおける全ての有効な回転値（0, 90, 180, 270）に対する詳細な`_size`スワップロジックの検証（特に180度のケース）。
*   `display` メソッドにおけるロギング挙動（リサイズが行われる場合と行われない場合）。
*   `__exit__` メソッドが例外発生時にも `close()` を呼び出すことの確認。
*   独立関数 `get_display_info()` が全くテストされていない。
    *   設定ファイルから情報を正しく読み込むケース。
    *   設定ファイルに情報がない場合に `None` を返すケース。
    *   `debug=True` 時のロギング挙動。

### 3. テストカバレッジ100%達成のための具体的な計画

以下のサブタスクを実行し、不足しているテストケースを追加します。

#### サブタスク一覧

1.  **`DispBase.__init__` の `debug` 引数に関するテスト追加**
    *   `debug=True` でインスタンス化した場合に、ロガーが正しくデバッグレベルのメッセージを記録することを確認するテストを追加します。
2.  **`rotation` プロパティのsetterの網羅的テスト**
    *   `rotation = 180` のケースで `_size` が `_native_size` と同じになること（スワップ解除）を明示的にテストします。
    *   既存の`test_set_rotation_to_0`と同様に、`rotation = 270`から`rotation = 0`への変更で`_size`が正しく戻ることをテストします。
3.  **`display` メソッドのロギングテスト追加**
    *   画像がリサイズされる場合にデバッグログが出力されること。
    *   画像がリサイズされない場合にデバッグログが出力されないことを確認するテストを追加します。
4.  **`__exit__` メソッドの例外発生時テスト追加**
    *   `with` ブロック内で例外が発生した場合でも、`__exit__` メソッドが `close()` を確実に呼び出すことを確認するテストを追加します。
5.  **`get_display_info` 関数のテスト追加**
    *   `MyConf` が width, height, rotation を持つ場合に、関数が正しい辞書を返すこと。
    *   `MyConf` がこれらの情報を持たない場合に、`None` を含む辞書を返すこと。
    *   `debug=True` で呼び出した場合に、デバッグログが正しく出力されること。

### 4. 実施手順

1.  `tests/test_01_disp_base.py` を開きます。
2.  上記「サブタスク一覧」で挙げた各テストケースに対応するテスト関数を追加または修正します。
    *   既存の`mock_pi_constructor`, `mock_logger`, `mock_pi_instance`, `MyConf`のパッチングメカニズムを参考にします。
3.  テスト実行コマンド (`mise run test` など) を使って、追加・修正したテストを実行し、パスすることを確認します。
4.  テストカバレッジレポートを生成し、`disp_base.py` のカバレッジが100%になっていることを確認します。
    *   (注: 現在の環境ではカバレッジレポート生成ツールは指定されていませんが、一般的なPythonプロジェクトでは`pytest-cov`などが利用されます。必要であれば、後続のステップで設定します。)

### 5. レビューと確認

本計画書に基づいてテストコードを実装した後、以下の観点でレビューを行います。
*   全てのテストケースが意図通りに機能しているか。
*   新たなテストが既存の機能を破壊していないか。
*   コードの可読性、保守性が損なわれていないか。

レビュー後、ユーザーに最終的な確認を求めます。

# 調査レポート：`ballanime` コマンドにおける `--mode` オプション削除の経緯

## 1. 調査概要
`uv run pi0disp ballanime` コマンドから削除された `--mode` オプションについて、Git履歴を遡り、その削除理由と当時の機能を調査した。

## 2. 調査結果

### 2.1 削除されたコミット
- **SHA**: `0bdd3d72672a6b92b43bd8c2f957d734dde9d346`
- **日時**: 2026年1月9日 13:00:32
- **コミットメッセージ**: `conductor(checkpoint): Checkpoint end of Phase 2 - performance_core_refactor_20260109`

### 2.2 削除理由
ドライバレベル（`ST7789V` クラス）で **Dirty Rectangle（差分更新）** 最適化が実装されたため。
従来、アプリケーション層（`ballanime.py`）で手動で行っていた描画領域の計算と部分更新（旧 `fast` モードの実装内容）が、ドライバ側で自動かつ透過的に行われるようになり、コードを簡素化できるようになった。

### 2.3 削除前の機能詳細
削除前、`--mode` オプションは以下の2つのモードを切り替えていた。

| モード | 説明 |
| :--- | :--- |
| `simple` (デフォルト) | 毎回背景をコピーし、全てのボールを描画してフレーム全体を `lcd.display()` で送信する。 |
| `fast` | `RegionOptimizer` を使用。ボールの現在位置と前回の位置から「汚れた領域（Dirty Region）」を算出し、`lcd.display_region()` を用いて変化のあった部分のみを更新する。 |

## 3. 技術的考察と復活の是非

### 3.1 現状の分析
現在の `pi0disp` アーキテクチャでは、`lcd.display(image)` を呼び出すと、ドライバ内部で前回のフレームとの差分が自動的に計算され、変化があった矩形領域のみが SPI で送信される。このため、アプリケーション側で `lcd.display_region()` を手動で制御するメリットが消失している。

### 3.2 復活の是非
**結論：現時点での復活は不要。**

- **理由**: 現在の「ドライバレベルでの自動最適化」は、アプリケーションコードをシンプルに保ちつつ、`fast` モードと同等以上のパフォーマンスを実現している。手動での領域計算（旧 `fast` モード）を復活させても、計算コストが増えるだけで SPI 送信データ量は変わらないため、実質的なメリットがない。
- **例外**: もし将来的に、ドライバレベルの差分検知では対応できない特殊な描画制御（例：レイヤー合成の最適化や、非常に複雑な動的エフェクトの部分更新）が必要になった場合には、再度検討の余地がある。

## 4. さらなる最適化の可能性（検討結果）

今回の調査過程で、`src/pi0disp/utils/` にある `Sprite` および `performance_core` (RegionOptimizer) の再評価を行った。

### 4.1 `Sprite` 活用の優位性
現在の「ドライバレベルの最適化」は、全ピクセルの画像比較（画像サイズに比例した計算コスト）を行っている。
一方で `Sprite` クラス（特に `CircleSprite`）を活用し、アプリケーション側で移動矩形を算出（オブジェクト数に比例した計算コスト）することで、以下のメリットが得られる：
- **CPU負荷の低減**: 画像走査のオーバーヘッドを削減できる。
- **描画効率の向上**: ドライバが画像を走査する前に、更新が必要な場所を明示的に指定できる。

### 4.2 `RegionOptimizer` による統合
`Sprite` が生成した複数の Dirty Region を `RegionOptimizer.merge_regions` で最適化することで、以下のバランスを調整できる：
- SPI 転送回数の抑制（コマンドオーバーヘッドの削減）。
- 転送ピクセル量の最小化。

## 5. 結論と次ステップの提案

### 結論
単純な機能としての `--mode`（旧 `fast` モード）の復活は不要であるが、`Sprite` および `RegionOptimizer` を活用した **「アプリケーション層主導の新・最適化モード」** の導入は、特に Raspberry Pi Zero 等の非力な環境における CPU 負荷低減に極めて有効である。

### 次ステップの提案
1.  **新しい最適化モードの設計**: ドライバの自動検知をバイパスし、`Sprite` と `RegionOptimizer` を連携させた描画エンジンの検討。
2.  **プロトタイプ実装トラックの作成**: `ballanime` を `Sprite` ベースにリファクタリングし、CPU 負荷がどの程度低減されるかを計測する新しい開発トラックの開始。


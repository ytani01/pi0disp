# Tasks02.md - `tests/` ディレクトリ全体のリファクタリングタスクリスト

## 1. 事前準備と環境設定

- [x] 現在の作業ディレクトリが `pi0disp` のルートであることを確認する。
- [x] 既存のテストがすべてパスしていることを確認する (`mise run test`)。
- [x] リファクタリングによる影響を局所化するため、新しいGitブランチを作成する。

## 2. 共通フィクスチャ・ヘルパーの整備

このセクションでは、テスト全体で再利用可能な共通のフィクスチャとヘルパー関数を `conftest.py` および `_testbase_cli.py` に集約します。

### 2.1. `conftest.py` の整理と共通フィクスチャの追加

- [x] `conftest.py` の内容を読み込み、既存フィクスチャの目的と利用状況を把握する。
- [x] **共通CLIモック環境フィクスチャの作成:**
    - [x] `conftest.py` に `@pytest.fixture` を使用した `cli_mock_env` または同様の名称のフィクスチャを作成する。
    - [x] このフィクスチャは、`click.testing.CliRunner` のインスタンス、`pigpio.pi` のモック、`Dynaconf` のモック（`bl_mock_env` の機能を汎用化したもの）を提供する。
    - [x] `pigpio.pi` のモックは `connected=True`、`get_PWM_dutycycle.return_value=0` を初期設定する。
    - [x] `Dynaconf` のモックは、`get.return_value` が `MagicMock` オブジェクトを返し、`spi.bl` などの属性アクセスを可能にする。
    - [x] このフィクスチャは、`(runner, mock_pi_instance, mock_dynaconf_instance)` のタプルを `yield` する。
- [x] **共通設定ファイルモックフィクスチャの作成 (オプション、検討):**
    - [x] 設定ファイルを一時的に作成し、`Dynaconf` が読み込む環境変数 (`SETTINGS_FILES_FOR_DYNACONF`) を設定・解除するフィクスチャを検討する。`cli_mock_env` の中で完結できる場合は別途作成しない。

### 2.2. `_testbase_cli.py` の改善

- [x] `_testbase_cli.py` の内容を読み込み、CLIテスト共通処理がどのように定義されているかを確認する。
- [x] `_testbase_cli.py` 内に、ステップ 2.1 で作成した `cli_mock_env` フィクスチャを利用する、より高レベルな CLI テストヘルパー関数またはクラスを定義する。
    - [x] これにより、各コマンドテストファイルでの `CliRunner().invoke(...)` の直接呼び出しを抽象化し、引数渡しや結果検証を簡素化できることを目指す。

## 3. ファイル名の変更とテストファイルの更新 (段階的)

共通フィクスチャやヘルパーを整備した後、各テストファイルを段階的にリファクタリングします。

### 3.1. ファイル名の変更

- [x] `test_00_conftest_01_basic.py` を `test_conftest_basic.py` にリネームする。
- [x] `test_00_conftest_02_interactive.py` を `test_conftest_interactive.py` にリネームする。
- [x] (任意) 他の `test_XX_` 形式のプレフィックスを持つファイル名について、必要に応じて、より明確な命名規則に基づきリネームする。

### 3.2. `conftest` 関連テストファイルの更新

- [x] `test_conftest_basic.py` を、`conftest.py` の変更と整合するように更新する。
- [x] `test_conftest_interactive.py` を、`conftest.py` の変更と整合するように更新する。

### 3.3. CLIコマンドテストファイルの更新

- [x] `test_13_cmd_bl.py` を、ステップ 2.1 で作成した `cli_mock_env` フィクスチャを利用するように書き換える。（既にリファクタリング済みのため、変更のレビューのみ）
- [x] `test_14_cmd_image.py` を、`cli_mock_env` フィクスチャおよび `_testbase_cli.py` のヘルパーを利用するように書き換える。
- [x] `test_15_cmd_rgb.py` を、`cli_mock_env` フィクスチャおよび `_testbase_cli.py` のヘルパーを利用するように書き換える。
- [x] `test_16_cmd_ballanime.py` を、`cli_mock_env` フィクスチャおよび `_testbase_cli.py` のヘルパーを利用するように書き換える。
- [x] `test_17_cmd_coltest.py` を、`cli_mock_env` フィクスチャおよび `_testbase_cli.py` のヘルパーを利用するように書き換える。
- [x] 各CLIコマンドテストファイルで、`pytest.mark.parametrize` を活用して複数のテストシナリオを簡潔に記述する。

### 3.4. `disp` モジュール関連テストファイルの更新

- [x] `test_01_disp_base.py` を読み込み、重複するセットアップやモックがあれば `conftest.py` にフィクスチャとして抽出し、テストコードを簡潔にする。
- [x] `test_02_disp_spi.py` を読み込み、重複するセットアップやモックがあれば `conftest.py` にフィクスチャとして抽出し、テストコードを簡潔にする。
- [x] `test_03_st7789v.py` を読み込み、重複するセットアップやモックがあれば `conftest.py` にフィクスチャとして抽出し、テストコードを簡潔にする。

## 4. テスト実行環境の最適化

### 4.1. テストのパラレル実行設定

- [x] `pytest-xdist` プラグインをインストールする。
- [x] `pyproject.toml` または `pytest.ini` に、テストのパラレル実行設定を追加する。

### 4.2. テストカバレッジ測定の導入

- [x] `pytest-cov` プラグインをインストールする。
- [x] `pyproject.toml` または `pytest.ini` に、テストカバレッジ測定設定を追加する。

## 5. 最終確認

- [x] `mise run lint` を実行し、すべてのファイルでコードスタイルが維持されていることを確認する。
- [x] `mise run mypy` を実行し、すべてのファイルで型エラーがないことを確認する。
- [x] `mise run test` (パラレル実行を含む) を実行し、すべてのテストがエラーなくパスすることを確認する。
- [x] テストカバレッジレポートを生成し、コードカバー率が適切であることを確認する。
- [x] リファクタリングによる変更内容をレビューし、Gitコミットを作成する。
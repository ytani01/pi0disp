# Plan02.md - テストプログラム全体のリファクタリング計画書

## 1. はじめに

本計画書は、`pi0disp` プロジェクトの `tests/` ディレクトリ配下にあるすべてのテストプログラムのリファクタリングについて記述するものです。プロジェクト全体のテストコードの品質向上、すなわち可読性、保守性、再利用性の向上、およびテスト実行の効率化を目的とします。

## 2. 現状分析

現在の `tests/` ディレクトリの構成は以下の通りです。

```
tests/
├───__pycache__/
├───__init__.py
├───_testbase_cli.py        # CLIテストの共通基盤と思われる
├───conftest.py             # pytestのフィクスチャやフック定義
├───test_00_conftest_01_basic.py
├───test_00_conftest_02_interactive.py # conftestのテストと思われる
├───test_01_disp_base.py    # `disp_base`モジュール関連のテスト
├───test_02_disp_spi.py     # `disp_spi`モジュール関連のテスト
├───test_03_st7789v.py      # `st7789v`モジュール関連のテスト
├───test_13_cmd_bl.py       # `bl`コマンドのテスト (直近でリファクタリング済み)
├───test_14_cmd_image.py    # `image`コマンドのテスト
├───test_15_cmd_rgb.py      # `rgb`コマンドのテスト
├───test_16_cmd_ballanime.py # `ballanime`コマンドのテスト
└───test_17_cmd_coltest.py   # `coltest`コマンドのテスト
```

### 現在のテストコードの一般的な特徴と課題:

*   **命名規則の不統一:** `test_00_conftest_01_basic.py` のようなファイル名のプレフィックスは、`pytest` の標準的な命名規則から逸脱しており、ファイルが増えると管理が煩雑になる可能性があります。
*   **フィクスチャの活用不足:** `conftest.py` が存在しますが、CLIコマンドテスト全体で共通して利用できるモック環境やユーティリティ関数が十分に抽象化されていない可能性があります（特に `test_13_cmd_bl.py` のリファクタリングで明らかになったように）。
*   **CLIテストの共通処理の重複:** 各 `test_XX_cmd_YY.py` ファイル内で `CliRunner` のインスタンス化やモックの設定が重複している可能性があります。`_testbase_cli.py` がその役割を担っている可能性もありますが、その内容を精査し、より汎用的な共通化が必要です。
*   **設定ファイル関連テストの統一性:** `pi0disp.toml` のような設定ファイルを必要とするテストにおいて、設定ファイルの準備やモックの方法が統一されていない可能性があります。
*   **モックの複雑性:** `patch` の直接使用が各テストファイルに散在している場合、テストの可読性を損ね、保守を困難にする可能性があります。フィクスチャによるモック管理が望ましいです。

## 3. リファクタリングの目標

*   **可読性の向上:** 各テストコードが簡潔で、テスト対象の動作を明確に表現できるようにする。
*   **保守性の向上:** テスト対象のコード変更に対して、テストコードの修正範囲を最小限に抑える。モックやフィクスチャを適切に利用することで、依存関係を疎にする。
*   **再利用性の向上:** 共通のセットアップ処理、モック設定、アサーションロジックをフィクスチャやヘルパー関数として抽出し、重複を排除する。
*   **テスト実行の効率化:** `pytest` の機能を最大限に活用し、テストの実行速度や安定性を向上させる。
*   **命名規則の統一:** プロジェクト全体のテストファイルや関数において、一貫性のある命名規則を適用する。

## 4. 具体的な計画

以下のステップでリファクタリングを実施します。

### ステップ 1: ファイル/ディレクトリ構造の整理と命名規則の統一

*   **タスク 1.1: 命名規則の統一**
    *   `test_00_conftest_01_basic.py` や `test_00_conftest_02_interactive.py` のようなファイル名のプレフィックスを削除し、`test_conftest_basic.py`、`test_conftest_interactive.py` のようにリネームする。
    *   `test_01_disp_base.py` などの `test_XX_` 形式のプレフィックスについては、必要性が低いと判断される場合を除き、現状維持を基本とする。より明確な命名が必要な場合は検討する。

### ステップ 2: `conftest.py` の強化とフィクスチャの活用

*   **タスク 2.1: 既存フィクスチャの精査と改善**
    *   `conftest.py` の内容を読み込み、既存のフィクスチャの目的と利用状況を把握する。
    *   必要に応じて、フィクスチャの命名、スコープ、依存関係を見直す。
*   **タスク 2.2: 共通 CLI モック環境フィクスチャの作成**
    *   `test_13_cmd_bl.py` で実装したモック環境 (`bl_mock_env` に相当する機能) を参考に、`CliRunner` のインスタンス、`pigpio.pi` のモック、`Dynaconf` のモックなどを提供する汎用的なフィクスチャを `conftest.py` に定義する。
    *   このフィクスチャは、テスト対象のCLIコマンドに応じてカスタマイズ可能なパラメータを持つことを検討する。
*   **タスク 2.3: 共通の設定ファイルモックフィクスチャの作成**
    *   `pi0disp.toml` のような設定ファイルを必要とするテストのために、一時的な設定ファイルを作成し、テスト後にクリーンアップするフィクスチャを作成する。
    *   `Dynaconf` がこの設定ファイルを読み込むよう、環境変数 `SETTINGS_FILES_FOR_DYNACONF` の設定と解除を含めて一元的に管理するフィクスチャを検討する。

### ステップ 3: CLI テスト共通基盤の改善

*   **タスク 3.1: `_testbase_cli.py` の精査と活用**
    *   `_testbase_cli.py` の内容を読み込み、CLIテストの共通処理がどのように定義されているかを確認する。
    *   `_testbase_cli.py` に、ステップ 2.2 で作成する共通CLIモック環境フィクスチャを利用した、より高レベルな CLI テストヘルパー関数やクラスを定義することを検討する。
    *   可能であれば、各CLIコマンドテストファイルから `CliRunner` の直接呼び出しをなくし、`_testbase_cli.py` のヘルパー経由に統一する。

### ステップ 4: 各テストファイルの整理と最適化

*   **タスク 4.1: `test_14_cmd_image.py` などのCLIコマンドテストファイルの更新**
    *   ステップ 2 で定義した共通CLIモック環境フィクスチャと、ステップ 3 で改善したCLIテスト共通基盤を利用するように、各CLIコマンドテストファイル (`test_14_cmd_image.py`, `test_15_cmd_rgb.py`, `test_16_cmd_ballanime.py`, `test_17_cmd_coltest.py`) を書き換える。
    *   `pytest.mark.parametrize` を活用し、複数のテストシナリオを簡潔に記述する。
    *   重複するモック設定やアサーションロジックを排除する。
*   **タスク 4.2: `test_disp_*.py` ファイルの整理**
    *   `test_01_disp_base.py`、`test_02_disp_spi.py`、`test_03_st7789v.py` を読み込み、重複するセットアップやモックがあれば `conftest.py` にフィクスチャとして抽出する。
    *   これらのファイルのテスト関数も、`pytest` のフィクスチャや `parametrize` を活用して簡潔にする。
*   **タスク 4.3: `test_conftest_*.py` ファイルのレビュー**
    *   これらのテストは `conftest.py` のフィクスチャが正しく動作するかを検証するためのものなので、基本的には現状維持とする。ただし、`conftest.py` の変更に応じて必要であれば更新する。

### ステップ 5: テスト実行環境の最適化

*   **タスク 5.1: テストのパラレル実行設定**
    *   `pytest-xdist` などのプラグインを利用したテストのパラレル実行を検討し、`pyproject.toml` や `pytest.ini` に設定を追加する。
*   **タスク 5.2: テストカバレッジ測定の導入**
    *   `pytest-cov` を利用したテストカバレッジの測定を導入し、`pyproject.toml` に設定を追加する。これにより、テストがコードをどれだけカバーしているかを把握し、テストの質を定量的に評価できるようにする。

## 6. 実施後の確認

リファクタリング完了後、以下の手順でコードの品質と機能が維持されていることを確認します。

*   **リンティングの実行:** `mise run lint` を実行し、コードスタイルがプロジェクトの標準に準拠していることを確認する。
*   **型チェックの実行:** `mise run mypy` を実行し、型エラーがないことを確認する。
*   **全テストの実行:** `mise run test` を実行し、すべてのテストがエラーなくパスすることを確認する。
*   **テストカバレッジの確認:** カバレッジレポートを生成し、コードカバー率が適切であることを確認する。

---

上記計画で、`tests/` ディレクトリ全体のテストプログラムのリファクタリングを進めてもよろしいでしょうか？
# Plan01.md - `tests/test_13_cmd_bl.py` リファクタリング計画書

## 1. はじめに

本計画書は、`tests/test_13_cmd_bl.py` ファイルのテストコードのリファクタリングについて記述するものです。現在のテストコードは機能していますが、可読性、保守性、およびテストの柔軟性をさらに向上させることを目的とします。

## 2. 現在の問題点

現在、`test_13_cmd_bl.py` では `run_with_mocks` というヘルパー関数を使用して、`pigpio.pi` および `Dynaconf` のモック設定とコマンドの実行をカプセル化しています。このアプローチには以下の改善点があります。

*   **ヘルパー関数の複雑性:** `run_with_mocks` 内でモックの初期化、設定ファイルの準備、コマンドの実行、環境変数の管理など、複数の役割を担っています。
*   **モック設定の柔軟性:** テストケースごとにモックの挙動を細かく制御したい場合、ヘルパー関数を修正するか、複雑な引数を渡す必要があり、柔軟性に欠ける場合があります。
*   **テスト構造の複雑化:** 各テストケースで `run_with_mocks` を呼び出し、結果とモックインスタンスを個別に受け取る形式が、`pytest` のフィクスチャを活用したよりシンプルな構造を妨げています。

## 3. リファクタリングの目標

*   **テスト関数の明確化:** 各テスト関数が「何をテストしているのか」をより明確にする。
*   **モック設定の簡素化:** `pytest` のフィクスチャを最大限に活用し、モックのセットアップロジックをテスト関数本体から切り離すことで、テストコードの記述量を減らし、可読性を向上させる。
*   **DRY (Don't Repeat Yourself) 原則の適用:** 共通のセットアップ処理をフィクスチャに集約し、重複コードを排除する。
*   **可読性と保守性の向上:** テストコードが簡潔になり、変更が容易になるようにする。
*   **テスト結果の取得方法の改善:** `CliRunner` の `result` オブジェクトを直接利用できるようにする。

## 4. 具体的な計画

以下のステップでリファクタリングを実施します。

### ステップ 1: 共通モック環境設定用フィクスチャの作成

`run_with_mocks` ヘルパー関数を廃止し、新しい `pytest` フィクスチャ `bl_mock_env` を作成します。このフィクスチャは、`bl` コマンドのテストに必要なモックオブジェクトをセットアップして提供します。

*   **フィクスチャの機能:**
    *   `@patch("pi0disp.commands.bl.pigpio.pi")` を使用して `pigpio.pi` クラスをモックし、そのインスタンス (`mock_pi_instance`) を作成します。`mock_pi_instance.connected = True` や `mock_pi_instance.get_PWM_dutycycle.return_value = 0` など、共通の初期設定を行います。
    *   `@patch("pi0disp.disp.disp_conf.Dynaconf")` を使用して `Dynaconf` クラスをモックし、そのインスタンス (`mock_dynaconf_instance`) を作成します。このモックインスタンスの `get.return_value` に `MagicMock` を設定し、その `spi` 属性も `MagicMock` に設定して、`spi.bl` などの属性アクセスを可能にします。
    *   フィクスチャは、`(mock_pi_instance, mock_dynaconf_instance)` のタプルを返します。
    *   テストの実行中、`CliRunner` が一時的にカレントディレクトリを変更するため、`Dynaconf` の環境変数を用いた設定ファイルパス指定は不要です。`Dynaconf` のデフォルトの検索パス (`.`) が一時ディレクトリを指すようになります。

### ステップ 2: 各テスト関数の書き換え

ステップ 1 で作成したフィクスチャ (`bl_mock_env`) を使用するように、既存のテスト関数を全面的に書き換えます。

*   **変更対象のテスト関数:**
    *   `test_config_nonzero`
    *   `test_config_zero`
    *   `test_option_nonzero`
    *   `test_option_zero`
    *   `test_clamp_with_config`
    *   `test_help_message` (修正不要だが、見直し)
*   **具体的な変更内容:**
    *   各テスト関数の引数に `bl_mock_env` を追加し、`(mock_pi_instance, mock_dynaconf)` のようにアンパックして使用します。
    *   設定ファイルの内容をシミュレートするテスト (`test_config_nonzero`, `test_config_zero`, `test_clamp_with_config`) では、`mock_dynaconf.get.return_value.spi.bl = bl_pin_value` のように、直接モックの `Dynaconf` インスタンスに `bl` の値を設定します。
    *   コマンドの実行は `CliRunner().invoke(bl_cmd, args)` を使用し、`result` オブジェクトから `exit_code` や `output` を確認します。
    *   `test_clamp_with_config` は、必要に応じて `pytest.mark.parametrize` を使用して、より簡潔に複数のシナリオをテストできるようにリファクタリングします。
    *   `test_help_message` は `bl_mock_env` を必要としないため、そのまま維持します。

## 5. 実施後の確認

リファクタリング完了後、以下の手順でコードの品質と機能が維持されていることを確認します。

*   **リンティングの実行:** `mise run lint` を実行し、コードスタイルがプロジェクトの標準に準拠していることを確認します。
*   **全テストの実行:** `mise run test` を実行し、すべてのテストがエラーなくパスすることを確認します。

---

上記計画で、`tests/test_13_cmd_bl.py` のリファクタリングを進めてもよろしいでしょうか？
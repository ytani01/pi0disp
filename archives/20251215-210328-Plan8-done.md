# Plan 8: Refactor `tests/test_02_disp_spi.py` to Pytest Style

`tests/test_02_disp_spi.py` を再確認した結果、さらなる改善点として、`unittest.TestCase` スタイルから、よりモダンな `pytest` スタイルへのリファクタリングを提案します。

## 概要

`pytest` は現在実行ランナーとして使われていますが、テストコード自体は `unittest` ライブラリのクラスベースになっています。これを `pytest` ネイティブな書き方に変更することで、ボイラープレート（決まり文句）を減らし、フィクスチャを活用した柔軟なテスト記述が可能になります。

## 改善案

### 1. `unittest.TestCase` からの脱却

クラスベースの継承をやめ、プレーンな関数ベースのテストに変更します。
- `class TestDispSpi(unittest.TestCase):` を削除
- `self.assertEqual` などのアサーションメソッドを、標準の `assert` 文に置き換え

### 2. `pytest` フィクスチャの導入

`setUp` / `tearDown` メソッドを、`pytest` の `fixture` に置き換えます。
これにより、リソースのセットアップとクリーンアップ（`yield` を使用）が一箇所にまとまり、可読性が向上します。

- `mock_pi_instance`
- `mock_disp_base_init`
- `mock_logger`
などをフィクスチャとして定義し、テスト関数の引数として受け取るようにします。

### 3. パッチ適用の整理

`unittest.mock.patch` のコンテキストマネージャやデコレータを整理し、`pytest-mock` プラグイン（`mocker` フィクスチャ）の使用も検討します（もしプロジェクトで許容される場合。今回は標準ライブラリの `patch` を継続利用しつつ、フィクスチャ内で適用する形を推奨）。

### 4. マジックナンバーの定数化

テスト内で使用されている `0x10`, `0x20` などのマジックナンバーを、わかりやすい定数名（例: `TEST_CMD`, `TEST_DATA`）に置き換えます。

## メリット

- コード量の削減と可読性の向上
- テストの独立性が高まる
- 強力な `pytest` の機能（パラメタライズドテストなど）が使いやすくなる

## 検証計画

- `mise run test` を実行し、リファクタリング前後でテスト結果が変わらない（すべてパスする）ことを確認します。
